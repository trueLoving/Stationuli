# Stationuli 文件传输场景设计文档

> **文档说明**：本文档详细描述 Stationuli 文件传输功能的完整设计，包括功能需求、UI设计、交互流程和技术实现建议。

## 目录

1. [功能需求](#功能需求)
2. [UI设计](#ui设计)
3. [交互流程](#交互流程)
4. [技术实现](#技术实现)
5. [优化建议](#优化建议)

---

## 功能需求

### 1.1 核心功能

#### 1.1.1 基础文件传输

- ✅ **文件发送**：支持发送单个文件到目标设备
- ✅ **文件接收**：自动接收来自其他设备的文件
- ✅ **进度显示**：实时显示传输进度（百分比、已传输/总大小）
- ✅ **跨平台支持**：PC ↔ PC、PC ↔ Android、Android ↔ Android
- ⚠️ **端到端加密**：X25519 + AES-256 加密传输（**待实现**，当前使用明文传输）

#### 1.1.2 高级功能（待实现）

- ❌ **断点续传**：传输中断后可以继续传输
- ❌ **传输队列**：支持多个文件排队传输
- ❌ **文件夹传输**：支持传输整个文件夹（保持目录结构）
- ❌ **传输历史**：记录所有传输历史（发送/接收）
- ❌ **传输统计**：显示传输统计（总大小、成功率、平均速度）
- ❌ **端到端加密**：X25519 + AES-256 加密传输（**高优先级安全功能**）

### 1.2 文件类型支持

- **所有文件类型**：支持传输任何格式的文件
- **大文件支持**：支持传输大文件（超过 5GB）
- **文件夹支持**：支持传输文件夹（待实现）

### 1.3 传输模式

#### 1.3.1 局域网传输（当前实现）

- 使用 mDNS 自动发现设备
- 通过 TCP 连接传输文件（**明文传输，未加密**）
- 适合同一局域网内的设备
- ⚠️ **安全风险**：所有数据都是明文传输，存在安全隐患

#### 1.3.2 跨网络传输（待实现）

- 使用票据系统（参考 Alt-SendMe）
- 通过 P2P NAT 穿透传输
- 适合不同网络环境下的设备

### 1.4 安全传输（待实现）

#### 1.4.1 当前状态

- ❌ **端到端加密未实现**：所有文件传输都是明文的
- ❌ **密钥交换未实现**：X25519 密钥交换模块只有占位代码
- ❌ **数据加密未实现**：AES-256 加密模块只有占位代码
- ⚠️ **安全风险**：🔴 **高** - 所有文件传输都是明文的，存在严重安全隐患

#### 1.4.2 安全传输设计目标

- ✅ **端到端加密**：X25519 密钥交换 + AES-256-GCM 加密
- ✅ **前向安全性**：每次传输使用新的会话密钥
- ✅ **完整性验证**：使用 BLAKE3 算法验证文件完整性
- ✅ **身份验证**：设备间首次连接时进行身份验证
- ✅ **密钥管理**：安全的密钥生成、交换和存储

#### 1.4.3 安全传输实现计划

**第一阶段：基础加密（高优先级）**

1. 实现 X25519 密钥交换
2. 实现 AES-256-GCM 加密/解密
3. 集成到文件传输流程

**第二阶段：安全增强（中优先级）**

1. 实现文件完整性验证（BLAKE3）
2. 实现设备身份验证
3. 实现密钥轮换机制

**第三阶段：安全审计（低优先级）**

1. 进行安全审计
2. 性能优化
3. 安全文档完善

---

## UI设计

### 2.1 桌面端UI设计

#### 2.1.1 文件发送界面

**触发方式**：

1. 点击设备卡片上的"文件传输"按钮
2. 拖拽文件到设备卡片
3. 使用快捷键 `Ctrl+Shift+F`

**界面布局**：

```
┌─────────────────────────────────────────────────────────┐
│  发送文件到: [设备名称]                                    │
│  ┌───────────────────────────────────────────────────┐  │
│  │  已选择文件:                                       │  │
│  │  ┌─────────────────────────────────────────────┐ │  │
│  │  │ 📄 document.pdf                              │ │  │
│  │  │    大小: 2.5 MB                              │ │  │
│  │  │    [删除]                                    │ │  │
│  │  └─────────────────────────────────────────────┘ │  │
│  │  ┌─────────────────────────────────────────────┐ │  │
│  │  │ 📁 folder/                                  │ │  │
│  │  │    大小: 150 MB (包含 25 个文件)             │ │  │
│  │  │    [删除]                                    │ │  │
│  │  └─────────────────────────────────────────────┘ │  │
│  │                                                   │  │
│  │  [+ 添加文件]  [添加文件夹]                       │  │
│  └───────────────────────────────────────────────────┘  │
│                                                           │
│  保存位置: [接收端默认位置 ▼]                            │
│                                                           │
│  [取消]                    [发送]                         │
└─────────────────────────────────────────────────────────┘
```

**功能说明**：

- 支持多文件选择
- 显示文件信息（名称、大小、类型）
- 支持删除已选文件
- 支持选择保存位置（接收端）
- 发送前确认界面

#### 2.1.2 传输进度界面

**界面布局**：

```
┌─────────────────────────────────────────────────────────┐
│  正在传输文件                                             │
│  ┌───────────────────────────────────────────────────┐  │
│  │  📄 document.pdf → [设备名称]                      │  │
│  │                                                     │  │
│  │  ████████████████░░░░░░░░  75%                     │  │
│  │                                                     │  │
│  │  已传输: 1.9 MB / 2.5 MB                           │  │
│  │  速度: 5.2 MB/s                                     │  │
│  │  剩余时间: 约 12 秒                                  │  │
│  │                                                     │  │
│  │  [暂停]  [取消]                                     │  │
│  └───────────────────────────────────────────────────┘  │
│                                                           │
│  传输队列 (2/3):                                          │
│  ┌───────────────────────────────────────────────────┐  │
│  │  ⏸️  image.jpg (等待中)                            │  │
│  │  ⏸️  video.mp4 (等待中)                            │  │
│  └───────────────────────────────────────────────────┘  │
└─────────────────────────────────────────────────────────┘
```

**功能说明**：

- 显示当前传输文件信息
- 实时进度条和百分比
- 显示传输速度（MB/s）
- 显示预计剩余时间
- 支持暂停/继续传输
- 支持取消传输
- 显示传输队列（多文件传输时）

#### 2.1.3 接收文件界面

**界面布局**：

```
┌─────────────────────────────────────────────────────────┐
│  接收的文件                                    [打开文件夹] │
│  ┌───────────────────────────────────────────────────┐  │
│  │  📄 document.pdf                                  │  │
│  │  来自: [设备名称]                                  │  │
│  │  大小: 2.5 MB | 接收时间: 2024-01-15 14:30        │  │
│  │  [预览] [打开] [打开位置] [删除]                   │  │
│  └───────────────────────────────────────────────────┘  │
│  ┌───────────────────────────────────────────────────┐  │
│  │  📷 image.jpg                                      │  │
│  │  来自: [设备名称]                                  │  │
│  │  大小: 1.2 MB | 接收时间: 2024-01-15 14:25        │  │
│  │  [预览] [打开] [打开位置] [删除]                   │  │
│  └───────────────────────────────────────────────────┘  │
│                                                           │
│  正在接收:                                                │
│  ┌───────────────────────────────────────────────────┐  │
│  │  📹 video.mp4                                       │  │
│  │  来自: [设备名称]                                  │  │
│  │  ████████████░░░░░░░░  60%                         │  │
│  │  速度: 3.5 MB/s | 剩余时间: 约 30 秒                │  │
│  └───────────────────────────────────────────────────┘  │
└─────────────────────────────────────────────────────────┘
```

**功能说明**：

- 显示接收的文件列表
- 显示文件来源设备
- 显示文件大小和接收时间
- 支持文件预览（图片、文本、PDF等）
- 支持打开文件
- 支持打开文件位置
- 支持删除文件
- 显示正在接收的文件进度

#### 2.1.4 传输历史界面

**界面布局**：

```
┌─────────────────────────────────────────────────────────┐
│  传输历史                                    [筛选] [搜索] │
│  ┌───────────────────────────────────────────────────┐  │
│  │  筛选: [全部 ▼] [今天 ▼] [本周 ▼] [本月 ▼]        │  │
│  │  类型: [全部 ▼] [发送 ▼] [接收 ▼]                  │  │
│  └───────────────────────────────────────────────────┘  │
│                                                           │
│  ┌───────────────────────────────────────────────────┐  │
│  │  ✅ 发送成功                                       │  │
│  │  📄 document.pdf → [设备名称]                      │  │
│  │  大小: 2.5 MB | 速度: 5.2 MB/s | 2024-01-15 14:30 │  │
│  │  [重新发送] [打开位置] [删除]                       │  │
│  └───────────────────────────────────────────────────┘  │
│  ┌───────────────────────────────────────────────────┐  │
│  │  ❌ 接收失败                                       │  │
│  │  📷 image.jpg ← [设备名称]                          │  │
│  │  大小: 1.2 MB | 错误: 连接中断 | 2024-01-15 14:25 │  │
│  │  [重新接收] [删除]                                 │  │
│  └───────────────────────────────────────────────────┘  │
│                                                           │
│  统计信息:                                                │
│  总传输量: 150 MB | 成功率: 95% | 平均速度: 4.8 MB/s    │
└─────────────────────────────────────────────────────────┘
```

**功能说明**：

- 显示所有传输历史（发送/接收）
- 支持按时间筛选（今天、本周、本月）
- 支持按类型筛选（发送、接收）
- 支持搜索文件名
- 显示传输状态（成功/失败）
- 支持重新发送/接收失败的文件
- 显示传输统计信息

### 2.2 移动端UI设计

#### 2.2.1 文件发送界面

**触发方式**：

1. 点击设备卡片上的"文件"按钮
2. 从其他应用分享文件到 Stationuli

**界面布局**：

```
┌─────────────────────────────────────────┐
│  ← 发送文件到: [设备名称]                 │
│  ─────────────────────────────────────  │
│                                          │
│  已选择文件:                             │
│  ┌────────────────────────────────────┐ │
│  │ 📄 document.pdf                    │ │
│  │ 2.5 MB                            │ │
│  │ [×]                               │ │
│  └────────────────────────────────────┘ │
│  ┌────────────────────────────────────┐ │
│  │ 📁 folder/                         │ │
│  │ 150 MB (25 个文件)                 │ │
│  │ [×]                               │ │
│  └────────────────────────────────────┘ │
│                                          │
│  [+ 添加文件]  [添加文件夹]               │
│                                          │
│  保存位置: [接收端默认位置 ▼]            │
│                                          │
│  ─────────────────────────────────────  │
│  [取消]              [发送]             │
└─────────────────────────────────────────┘
```

**功能说明**：

- 支持多文件选择
- 显示文件信息（名称、大小）
- 支持删除已选文件
- 支持选择保存位置
- 底部操作栏固定

#### 2.2.2 传输进度界面

**界面布局**：

```
┌─────────────────────────────────────────┐
│  ← 正在传输                             │
│  ─────────────────────────────────────  │
│                                          │
│  📄 document.pdf                        │
│  → [设备名称]                           │
│                                          │
│  ████████████████░░░░░░░░               │
│  75%                                    │
│                                          │
│  已传输: 1.9 MB / 2.5 MB                │
│  速度: 5.2 MB/s                         │
│  剩余时间: 约 12 秒                      │
│                                          │
│  ─────────────────────────────────────  │
│  [暂停]              [取消]             │
│                                          │
│  传输队列 (2/3):                         │
│  • ⏸️  image.jpg (等待中)                │
│  • ⏸️  video.mp4 (等待中)                │
└─────────────────────────────────────────┘
```

**功能说明**：

- 全屏显示传输进度
- 显示当前传输文件信息
- 实时进度条和百分比
- 显示传输速度和剩余时间
- 支持暂停/取消传输
- 显示传输队列

#### 2.2.3 接收文件界面

**界面布局**：

```
┌─────────────────────────────────────────┐
│  接收的文件              [打开文件夹]     │
│  ─────────────────────────────────────  │
│                                          │
│  📄 document.pdf                         │
│  来自: [设备名称]                        │
│  2.5 MB | 2024-01-15 14:30              │
│  [预览] [打开] [更多]                    │
│  ─────────────────────────────────────  │
│                                          │
│  📷 image.jpg                            │
│  来自: [设备名称]                        │
│  1.2 MB | 2024-01-15 14:25              │
│  [预览] [打开] [更多]                    │
│  ─────────────────────────────────────  │
│                                          │
│  正在接收:                                │
│  📹 video.mp4                            │
│  来自: [设备名称]                        │
│  ████████████░░░░░░░░  60%              │
│  3.5 MB/s | 约 30 秒                     │
└─────────────────────────────────────────┘
```

**功能说明**：

- 列表式布局（更适合移动端）
- 显示接收的文件信息
- 支持文件预览
- 支持打开文件
- 支持更多操作（长按菜单）
- 显示正在接收的文件进度

#### 2.2.4 传输历史界面

**界面布局**：

```
┌─────────────────────────────────────────┐
│  传输历史              [筛选] [搜索]      │
│  ─────────────────────────────────────  │
│                                          │
│  [全部] [今天] [本周] [本月]             │
│  [发送] [接收]                           │
│                                          │
│  ✅ 发送成功                             │
│  📄 document.pdf → [设备名称]            │
│  2.5 MB | 5.2 MB/s | 14:30              │
│  [重新发送] [更多]                       │
│  ─────────────────────────────────────  │
│                                          │
│  ❌ 接收失败                             │
│  📷 image.jpg ← [设备名称]               │
│  1.2 MB | 连接中断 | 14:25              │
│  [重新接收] [更多]                       │
│  ─────────────────────────────────────  │
│                                          │
│  统计: 150 MB | 95% | 4.8 MB/s          │
└─────────────────────────────────────────┘
```

**功能说明**：

- 顶部筛选栏（滑动切换）
- 显示传输历史列表
- 支持重新发送/接收
- 显示传输统计

---

## 交互流程

### 3.1 发送文件流程

#### 3.1.1 桌面端流程

```
用户操作
    ↓
方式1: 点击设备卡片"文件传输"按钮
方式2: 拖拽文件到设备卡片
方式3: 使用快捷键 Ctrl+Shift+F
    ↓
打开文件选择对话框
    ↓
用户选择文件/文件夹
    ↓
显示文件发送确认界面
    ├─ 显示已选文件列表
    ├─ 显示目标设备信息
    ├─ 显示文件总大小
    └─ 支持修改文件名（可选）
    ↓
用户点击"发送"按钮
    ↓
建立TCP连接
    ↓
显示传输进度界面
    ├─ 实时进度条
    ├─ 传输速度
    ├─ 剩余时间
    └─ 暂停/取消按钮
    ↓
传输完成
    ├─ 显示成功动画
    ├─ 发送系统通知
    └─ 记录传输历史
```

#### 3.1.2 移动端流程

```
用户操作
    ↓
方式1: 点击设备卡片"文件"按钮
方式2: 从其他应用分享文件到 Stationuli
    ↓
打开文件选择器（系统原生）
    ↓
用户选择文件/文件夹
    ↓
显示文件发送确认界面
    ├─ 显示已选文件列表
    ├─ 显示目标设备信息
    └─ 支持选择保存位置
    ↓
用户点击"发送"按钮
    ↓
建立TCP连接
    ↓
全屏显示传输进度
    ├─ 实时进度条
    ├─ 传输速度
    ├─ 剩余时间
    └─ 暂停/取消按钮
    ↓
传输完成
    ├─ 显示成功提示
    ├─ 发送系统通知
    └─ 记录传输历史
```

### 3.2 接收文件流程

#### 3.2.1 桌面端流程

```
其他设备发送文件
    ↓
Stationuli 检测到文件传输请求
    ↓
显示接收确认对话框（可选）
    ├─ 显示发送方设备信息
    ├─ 显示文件信息（名称、大小）
    ├─ 显示保存位置
    └─ [接受] [拒绝] 按钮
    ↓
用户点击"接受"（或自动接受）
    ↓
开始接收文件
    ↓
在"接收的文件"区域显示进度
    ├─ 实时进度条
    ├─ 传输速度
    └─ 剩余时间
    ↓
接收完成
    ├─ 文件保存到指定位置
    ├─ 显示成功通知
    ├─ 添加到接收文件列表
    └─ 记录传输历史
```

#### 3.2.2 移动端流程

```
其他设备发送文件
    ↓
Stationuli 检测到文件传输请求
    ↓
显示接收通知（系统通知栏）
    ├─ 显示发送方设备信息
    ├─ 显示文件信息
    └─ [接受] [拒绝] 按钮
    ↓
用户点击"接受"（或自动接受）
    ↓
开始接收文件
    ↓
在通知栏显示传输进度
    ├─ 实时进度条
    ├─ 传输速度
    └─ 剩余时间
    ↓
接收完成
    ├─ 文件保存到指定位置
    ├─ 显示成功通知
    ├─ 添加到接收文件列表
    └─ 记录传输历史
```

### 3.3 传输队列流程

```
用户选择多个文件发送
    ↓
文件添加到传输队列
    ↓
按顺序传输文件
    ├─ 当前传输: 文件1
    ├─ 等待中: 文件2, 文件3
    └─ 显示队列进度 (1/3)
    ↓
文件1传输完成
    ↓
自动开始传输文件2
    ├─ 当前传输: 文件2
    ├─ 等待中: 文件3
    └─ 显示队列进度 (2/3)
    ↓
所有文件传输完成
    ├─ 显示完成通知
    └─ 记录传输历史
```

### 3.4 断点续传流程（待实现）

```
文件传输中断（网络断开、应用关闭等）
    ↓
系统记录已传输的字节数
    ↓
用户重新连接/打开应用
    ↓
系统检测到未完成的传输
    ↓
显示断点续传提示
    ├─ 显示文件信息
    ├─ 显示已传输/总大小
    └─ [继续传输] [取消] 按钮
    ↓
用户点击"继续传输"
    ↓
从断点位置继续传输
    ↓
传输完成
```

---

## 技术实现

### 4.1 当前实现

#### 4.1.1 传输协议

**消息类型**：

```rust
pub enum TransferMessage {
    StartTransfer {
        file_name: String,
        file_size: u64,
        total_chunks: u64,
    },
    Chunk {
        chunk_id: u64,
        data: Vec<u8>,
    },
    Complete,
    Error(String),
}
```

**传输流程**：

1. 建立 TCP 连接（**明文连接，未加密**）
2. 发送 `StartTransfer` 消息（包含文件信息，**明文传输**）
3. 分片发送文件数据（每个分片 1MB，**明文传输**）
4. 发送 `Complete` 消息（**明文传输**）
5. 关闭连接

⚠️ **安全警告**：当前所有数据都是明文传输，包括文件名、文件大小和文件内容。

#### 4.1.2 文件分片

- **分片大小**：1MB per chunk
- **分片格式**：`FileChunk { chunk_id, data }`
- **传输方式**：顺序传输，每 10 个分片记录一次进度
- ⚠️ **安全状态**：所有分片都是明文传输

#### 4.1.3 进度回调

```rust
progress_callback: Option<Box<dyn Fn(u64, u64) + Send + Sync>>
// (sent_bytes, total_bytes)
```

#### 4.1.4 加密模块状态

**当前状态**：❌ **未实现**

- `packages/core/src/crypto/encryption.rs` - AES-256 加密模块只有 TODO 占位代码
- `packages/core/src/crypto/key_exchange.rs` - X25519 密钥交换模块只有 TODO 占位代码
- 虽然依赖中包含了 `ring` 和 `x25519-dalek`，但完全没有使用

**详细分析**：请参考 `.local/端到端加密实现状态分析.md`

### 4.2 待实现功能

#### 4.2.1 断点续传

**实现方案**：

1. **传输元数据存储**
   - 使用 SQLite 存储传输元数据
   - 记录：文件路径、目标设备、已传输字节数、文件哈希

2. **断点检测**
   - 传输中断时保存当前状态
   - 重新连接时检测未完成的传输

3. **续传协议**

   ```rust
   pub enum TransferMessage {
       StartTransfer { ... },
       ResumeTransfer {
           file_name: String,
           resume_from: u64,  // 从哪个字节开始
       },
       Chunk { ... },
       Complete,
   }
   ```

4. **文件完整性验证**
   - 使用 BLAKE3 算法计算文件哈希
   - 传输完成后验证文件完整性

#### 4.2.2 传输队列

**实现方案**：

1. **队列管理**
   - 使用队列数据结构管理待传输文件
   - 支持添加、删除、重新排序

2. **并发控制**
   - 支持单文件传输（当前）
   - 支持多文件并行传输（可选）

3. **队列状态**
   ```rust
   pub struct TransferQueue {
       current: Option<TransferTask>,
       waiting: Vec<TransferTask>,
       completed: Vec<TransferTask>,
   }
   ```

#### 4.2.3 文件夹传输

**实现方案**：

1. **目录结构保持**
   - 传输文件夹时保持目录结构
   - 使用相对路径传输

2. **传输消息扩展**

   ```rust
   pub enum TransferMessage {
       StartTransfer { ... },
       StartFolder {
           folder_name: String,
           file_count: u64,
           total_size: u64,
       },
       FileInFolder {
           relative_path: String,
           file_name: String,
           file_size: u64,
       },
       Chunk { ... },
       Complete,
   }
   ```

3. **进度显示**
   - 显示文件夹传输进度（文件数/总文件数）
   - 显示当前传输的文件名

#### 4.2.4 传输历史

**实现方案**：

1. **数据存储**
   - 使用 SQLite 存储传输历史
   - 表结构：
     ```sql
     CREATE TABLE transfer_history (
         id INTEGER PRIMARY KEY,
         file_name TEXT,
         file_size INTEGER,
         source_device TEXT,
         target_device TEXT,
         direction TEXT,  -- 'send' or 'receive'
         status TEXT,     -- 'success' or 'failed'
         speed REAL,      -- MB/s
         start_time INTEGER,
         end_time INTEGER,
         error_message TEXT
     );
     ```

2. **历史查询**
   - 支持按时间范围查询
   - 支持按设备查询
   - 支持按文件类型查询
   - 支持搜索文件名

#### 4.2.5 跨网络传输（票据系统）

**实现方案**：

1. **票据生成**
   - 生成一次性传输票据
   - 票据包含：文件信息、P2P 连接信息、加密密钥

2. **P2P NAT 穿透**
   - 使用 QUIC 协议实现 NAT 穿透
   - 参考 Iroh P2P 网络技术栈

3. **票据格式**
   ```json
   {
     "ticket_id": "xxx",
     "file_info": {
       "name": "document.pdf",
       "size": 2621440,
       "hash": "xxx"
     },
     "p2p_info": {
       "peer_id": "xxx",
       "relay_server": "xxx"
     },
     "encryption_key": "xxx",
     "expires_at": 1234567890
   }
   ```

#### 4.2.6 端到端加密实现（高优先级）

**实现方案**：

1. **X25519 密钥交换**

   ```rust
   use x25519_dalek::{PublicKey, StaticSecret, SharedSecret};

   pub struct KeyExchange {
       private_key: StaticSecret,
       public_key: PublicKey,
   }

   impl KeyExchange {
       pub fn new() -> Self {
           let private_key = StaticSecret::random_from_rng(&mut rand::thread_rng());
           let public_key = PublicKey::from(&private_key);
           Self { private_key, public_key }
       }

       pub fn get_public_key(&self) -> &PublicKey {
           &self.public_key
       }

       pub fn exchange(&self, peer_public_key: &PublicKey) -> SharedSecret {
           self.private_key.diffie_hellman(peer_public_key)
       }
   }
   ```

2. **AES-256-GCM 加密**

   ```rust
   use ring::aead::{Aad, BoundKey, Nonce, NonceSequence, OpeningKey,
                     SealingKey, UnboundKey, AES_256_GCM};
   use ring::rand::{SecureRandom, SystemRandom};

   pub struct Encryption {
       key: [u8; 32],  // AES-256 需要 32 字节密钥
   }

   impl Encryption {
       pub fn new(key: [u8; 32]) -> Self {
           Self { key }
       }

       pub fn encrypt(&self, data: &[u8]) -> Result<Vec<u8>> {
           let unbound_key = UnboundKey::new(&AES_256_GCM, &self.key)?;
           let nonce = self.generate_nonce()?;
           let mut sealing_key = SealingKey::new(unbound_key, NonceSequence::new(&nonce));

           let mut in_out = data.to_vec();
           let tag = sealing_key.seal_in_place_separate_tag(Aad::empty(), &mut in_out)?;

           // 将 nonce 和 tag 附加到密文
           let mut result = nonce.to_vec();
           result.extend_from_slice(&tag.as_ref());
           result.extend_from_slice(&in_out);

           Ok(result)
       }

       pub fn decrypt(&self, encrypted_data: &[u8]) -> Result<Vec<u8>> {
           // 实现解密逻辑
           // ...
       }
   }
   ```

3. **集成到文件传输流程**

   ```rust
   // 1. 建立 TCP 连接
   let mut connection = TcpConnection::connect(target_address, target_port).await?;

   // 2. 执行密钥交换
   let key_exchange = KeyExchange::new();
   let public_key = key_exchange.get_public_key();
   // 发送公钥给对方，接收对方的公钥
   // ... 密钥交换协议 ...

   // 3. 生成共享密钥
   let shared_secret = key_exchange.exchange(&peer_public_key);
   let encryption_key = derive_aes_key(&shared_secret);

   // 4. 创建加密器
   let encryption = Encryption::new(encryption_key);

   // 5. 加密并发送数据
   let plaintext = serde_json::to_vec(&start_msg)?;
   let ciphertext = encryption.encrypt(&plaintext)?;
   connection.send(&ciphertext).await?;
   ```

4. **文件完整性验证**

   ```rust
   use blake3;

   // 发送端：计算文件哈希
   let file_hash = blake3::hash(&file_data);

   // 接收端：验证文件哈希
   let received_hash = blake3::hash(&received_data);
   assert_eq!(file_hash, received_hash);
   ```

5. **安全传输协议流程**
   ```
   1. 建立 TCP 连接
   2. 执行密钥交换（X25519）
      - 发送方发送公钥
      - 接收方发送公钥
      - 双方计算共享密钥
   3. 派生 AES-256 密钥
   4. 加密并传输文件
      - 加密文件元数据（文件名、大小等）
      - 加密文件分片
      - 计算并传输文件哈希
   5. 接收方验证文件完整性
   6. 关闭连接
   ```

---

## 优化建议

### 5.1 UI优化

#### 5.1.1 桌面端

- ✅ 支持拖拽文件到设备卡片直接传输
- ✅ 支持文件预览（图片、文本、PDF）
- ✅ 支持传输队列可视化
- ✅ 支持传输历史筛选和搜索
- ✅ 支持批量文件操作

#### 5.1.2 移动端

- ✅ 支持从其他应用分享文件
- ✅ 支持手势操作（左滑删除、长按菜单）
- ✅ 支持后台传输（应用最小化后继续传输）
- ✅ 支持通知栏显示传输进度
- ✅ 支持文件预览（全屏预览）

### 5.2 功能优化

#### 5.2.1 传输性能

- ⚠️ **多线程传输**：支持多文件并行传输
- ⚠️ **传输压缩**：对文本文件等进行压缩传输
- ⚠️ **网络自适应**：根据网络状况自动调整传输策略
- ⚠️ **传输速度优化**：优化 TCP 缓冲区大小

#### 5.2.2 传输稳定性

- ⚠️ **自动重连**：连接断开后自动尝试重连
- ⚠️ **心跳检测**：定期检测连接状态
- ⚠️ **错误恢复**：传输错误时自动重试
- ⚠️ **断点续传**：传输中断后可以继续传输

#### 5.2.3 用户体验

- ⚠️ **传输通知**：文件传输完成通知
- ⚠️ **传输统计**：显示传输统计（总大小、成功率、平均速度）
- ⚠️ **传输历史**：记录所有传输历史
- ⚠️ **文件预览**：支持文件预览功能

### 5.3 优先级建议

#### 🔴 高优先级（安全相关，立即实现）

1. ⚠️ **端到端加密** - X25519 + AES-256 加密传输（**安全关键功能**）
2. ⚠️ **文件完整性验证** - 使用 BLAKE3 算法验证文件完整性
3. ⚠️ **设备身份验证** - 首次连接时进行设备身份验证

#### 🟡 高优先级（功能完善）

1. ✅ **断点续传** - 文件传输的核心功能
2. ✅ **传输队列** - 支持多文件排队传输
3. ✅ **传输历史** - 记录传输历史
4. ✅ **文件预览** - 提升用户体验

#### 🟢 中优先级（体验提升）

1. ⚠️ **文件夹传输** - 支持传输整个文件夹
2. ⚠️ **传输统计** - 显示传输统计信息
3. ⚠️ **后台传输** - 支持应用最小化后继续传输
4. ⚠️ **跨网络传输** - 支持跨网络文件传输（票据系统）

#### ⚪ 低优先级（性能优化）

1. ⏳ **传输压缩** - 对文本文件等进行压缩传输
2. ⏳ **多线程传输** - 支持多文件并行传输
3. ⏳ **网络自适应** - 根据网络状况自动调整传输策略
4. ⏳ **密钥轮换** - 定期轮换加密密钥

---

## 总结

Stationuli 的文件传输功能已经实现了基础的文件发送和接收功能，支持跨平台传输。**但是，端到端加密功能尚未实现，所有文件传输都是明文的，存在严重安全隐患。**

### 当前状态

**已实现**：

- ✅ 基础文件传输（发送/接收）
- ✅ 进度显示
- ✅ 跨平台支持

**未实现（高优先级）**：

- ❌ **端到端加密** - X25519 + AES-256（**安全关键功能，必须实现**）
- ❌ **文件完整性验证** - BLAKE3 哈希验证
- ❌ **设备身份验证** - 首次连接时的身份验证

**未实现（功能完善）**：

- ❌ 断点续传
- ❌ 传输队列
- ❌ 传输历史
- ❌ 文件预览
- ❌ 跨网络传输

### 安全警告

⚠️ **重要**：当前所有文件传输都是明文的，包括：

- 文件名和文件大小（元数据）
- 文件内容（所有数据）
- 传输协议消息

**风险**：

- 🔴 局域网内任何设备都可以截获数据
- 🔴 公共 WiFi 环境下存在中间人攻击风险
- 🔴 不符合隐私保护要求
- 🔴 不适合传输敏感数据

### 实现优先级

**立即实现（安全相关）**：

1. 端到端加密（X25519 + AES-256）
2. 文件完整性验证（BLAKE3）
3. 设备身份验证

**尽快实现（功能完善）**：

1. 断点续传
2. 传输队列
3. 传输历史
4. 文件预览

**后续实现（体验优化）**：

1. 跨网络传输
2. 传输统计
3. 后台传输

### 建议

1. **立即更新文档**：在 README 和所有文档中明确说明加密功能尚未实现
2. **优先实现加密**：端到端加密是安全关键功能，必须优先实现
3. **安全审计**：实现加密后，进行安全审计和测试

通过这些优化，Stationuli 可以成为一款**安全、功能完善、体验优秀**的个人工作站文件传输解决方案。

**详细的安全分析**：请参考 `.local/端到端加密实现状态分析.md`
