name: Release

# 仅支持手动触发，支持选择发布目标
on:
  workflow_dispatch:
    inputs:
      target:
        description: '选择发布目标'
        required: true
        type: choice
        options:
          - all
          - mac
          - windows
          - android
        default: 'all'
      create_release:
        description: '是否创建 GitHub Release'
        required: true
        type: boolean
        default: false

jobs:
  build-mac:
    if: ${{ inputs.target == 'mac' || inputs.target == 'all' }}
    permissions:
      contents: write
    strategy:
      fail-fast: false
      matrix:
        include:
          - platform: 'macos-latest'
            args: '--target aarch64-apple-darwin --bundles dmg'
            artifact_name: 'Stationuli-macos-arm64'
          - platform: 'macos-latest'
            args: '--target x86_64-apple-darwin --bundles dmg'
            artifact_name: 'Stationuli-macos-x86_64'

    runs-on: ${{ matrix.platform }}

    steps:
      - name: Checkout code
        uses: actions/checkout@v4

      - name: Setup pnpm
        uses: pnpm/action-setup@v2
        with:
          version: 10.18.3

      - name: Setup Node.js
        uses: actions/setup-node@v4
        with:
          node-version: '22'
          cache: 'pnpm'

      - name: Install dependencies
        run: pnpm install --frozen-lockfile

      - name: Setup Rust
        uses: dtolnay/rust-toolchain@stable
        with:
          targets: aarch64-apple-darwin,x86_64-apple-darwin

      - name: Build Desktop App  
        run: | 
          echo "=== 构建参数 ==="
          echo "args: ${{ matrix.args }}"
          echo "平台: ${{ matrix.platform }}"
          pnpm build:desktop ${{ matrix.args }} || (echo "构建失败，退出码: $?" && exit 1) 
  
      - name: Debug - List target directory structure
        shell: bash
        run: |
          echo "=== target 目录结构 ==="
          if [ -d "target" ]; then
            echo ""
            echo "--- 所有目录列表 ---"
            find target -type d | sort
            echo ""
            echo "--- bundle 目录中的文件 ---"
            find target -path "*/bundle/*" -type f 2>/dev/null | head -20 || echo "未找到 bundle 文件"
            echo ""
            echo "--- macOS 构建产物 (.dmg) ---"
            find target -name "*.dmg" 2>/dev/null | head -10 || echo "未找到 .dmg 文件"
          else
            echo "target 目录不存在"
          fi
  
      - name: Upload Desktop Artifacts
        uses: actions/upload-artifact@v4
        with:
          name: ${{ matrix.artifact_name }}
          path: |
            target/aarch64-apple-darwin/release/bundle/dmg/*.dmg
            target/x86_64-apple-darwin/release/bundle/dmg/*.dmg
          retention-days: 7

  build-windows:
    if: ${{ inputs.target == 'windows' || inputs.target == 'all' }}
    permissions:
      contents: write
    runs-on: windows-latest

    steps:
      - name: Checkout code
        uses: actions/checkout@v4

      - name: Setup pnpm
        uses: pnpm/action-setup@v2
        with:
          version: 10.18.3

      - name: Setup Node.js
        uses: actions/setup-node@v4
        with:
          node-version: '22'
          cache: 'pnpm'

      - name: Install dependencies
        run: pnpm install --frozen-lockfile

      - name: Setup Rust
        uses: dtolnay/rust-toolchain@stable

      - name: Install NSIS
        shell: pwsh
        run: |
          Write-Host "=== 安装 NSIS ==="
          if (Get-Command makensis.exe -ErrorAction SilentlyContinue) {
            Write-Host "NSIS 已安装"
            makensis.exe -VERSION
          } else {
            Write-Host "正在使用 winget 安装 NSIS..."
            winget install --id NSIS.NSIS --silent --accept-package-agreements --accept-source-agreements
            # 刷新环境变量
            $env:Path = [System.Environment]::GetEnvironmentVariable("Path","Machine") + ";" + [System.Environment]::GetEnvironmentVariable("Path","User")
            # 尝试找到 NSIS 安装路径
            $nsisPath = "$env:ProgramFiles\NSIS\makensis.exe"
            if (Test-Path $nsisPath) {
              $env:Path += ";$env:ProgramFiles\NSIS"
              Write-Host "✓ NSIS 安装成功"
              & $nsisPath -VERSION
            } else {
              Write-Host "✗ NSIS 安装失败，将只生成 MSI 安装包"
            }
          }

      - name: Check Windows build tools
        shell: pwsh
        run: |
          Write-Host "=== 检查 Windows 构建工具 ==="
          Write-Host "检查 WiX (MSI 需要):"
          if (Get-Command light.exe -ErrorAction SilentlyContinue) {
            Write-Host "✓ WiX 已安装"
            light.exe -? | Select-Object -First 1
          } else {
            Write-Host "✗ WiX 未找到 (MSI 构建可能需要)"
          }
          Write-Host ""
          Write-Host "检查 NSIS (NSIS 安装包需要):"
          $nsisPath = "$env:ProgramFiles\NSIS\makensis.exe"
          if (Test-Path $nsisPath) {
            $env:Path += ";$env:ProgramFiles\NSIS"
          }
          if (Get-Command makensis.exe -ErrorAction SilentlyContinue) {
            Write-Host "✓ NSIS 已安装"
            makensis.exe -VERSION
          } else {
            Write-Host "✗ NSIS 未找到 (NSIS 构建可能需要)"
          }

      - name: Build Desktop App  
        run: | 
          echo "=== 构建参数 ==="
          echo "平台: windows-latest"
          pnpm build:desktop || (echo "构建失败，退出码: $?" && exit 1) 
  
      - name: Debug - List target directory structure
        shell: pwsh
        run: |
          Write-Host "=== target 目录结构 ==="
          if (Test-Path "target") {
            Write-Host ""
            Write-Host "--- 所有目录列表 ---"
            Get-ChildItem -Path target -Recurse -Directory | Select-Object -ExpandProperty FullName | Sort-Object
            Write-Host ""
            Write-Host "--- bundle 目录中的文件 ---"
            Get-ChildItem -Path target -Recurse -Filter "*bundle*" -File | Select-Object -First 20 -ExpandProperty FullName
            Write-Host ""
            Write-Host "--- Windows 构建产物 (.msi, .exe) ---"
            Get-ChildItem -Path target -Recurse -Include *.msi,*.exe | Select-Object -First 10 -ExpandProperty FullName
          } else {
            Write-Host "target 目录不存在"
          }
  
      - name: Upload Desktop Artifacts
        uses: actions/upload-artifact@v4
        with:
          name: Stationuli-windows
          path: |
            target/release/bundle/msi/*.msi
            target/release/bundle/nsis/*.exe
          retention-days: 7

  build-android:
    if: ${{ inputs.target == 'android' || inputs.target == 'all' }}
    runs-on: ubuntu-latest

    steps:
      - name: Checkout code
        uses: actions/checkout@v4

      - name: Setup pnpm
        uses: pnpm/action-setup@v2
        with:
          version: 10.18.3

      - name: Setup Node.js
        uses: actions/setup-node@v4
        with:
          node-version: '22'
          cache: 'pnpm'

      - name: Install dependencies
        run: pnpm install --frozen-lockfile

      - name: Setup Java
        uses: actions/setup-java@v4
        with:
          distribution: 'temurin'
          java-version: '17'

      - name: Setup Android SDK
        uses: android-actions/setup-android@v3
        with:
          api-level: 34
          build-tools: 34.0.0
          ndk-version: 25.1.8937393

      - name: Setup Rust
        uses: dtolnay/rust-toolchain@stable
        with:
          targets: aarch64-linux-android,armv7-linux-androideabi,i686-linux-android,x86_64-linux-android

      - name: Cache Rust dependencies
        uses: actions/cache@v3
        with:
          path: |
            ~/.cargo/bin/
            ~/.cargo/registry/index/
            ~/.cargo/registry/cache/
            ~/.cargo/git/db/
            target/
          key: ${{ runner.os }}-rust-android-${{ hashFiles('**/Cargo.lock') }}
          restore-keys: |
            ${{ runner.os }}-rust-android-

      - name: Cache Gradle
        uses: actions/cache@v3
        with:
          path: |
            ~/.gradle/caches
            ~/.gradle/wrapper
          key: ${{ runner.os }}-gradle-${{ hashFiles('**/*.gradle*') }}
          restore-keys: |
            ${{ runner.os }}-gradle-

      - name: Check Android Signing Secret
        id: check_signing
        run: |
          if [ -n "${{ secrets.ANDROID_KEYSTORE_BASE64 }}" ]; then
            echo "has_signing=true" >> $GITHUB_OUTPUT
          else
            echo "has_signing=false" >> $GITHUB_OUTPUT
          fi

      - name: Setup Android Signing
        if: steps.check_signing.outputs.has_signing == 'true'
        run: |
          cd apps/mobile/src-tauri
          
          # 创建密钥库目录并保存密钥库文件
          mkdir -p ~/.android
          echo "${{ secrets.ANDROID_KEYSTORE_BASE64 }}" | base64 -d > ~/.android/upload-keystore.jks
          
          # 从 keystore.properties.example 复制为 keystore.properties
          cp sign-apk/keystore.properties.example sign-apk/keystore.properties
          
          # 修改 keystore.properties 中的配置项
          KEYSTORE_PATH="$HOME/.android/upload-keystore.jks"
          KEY_ALIAS="${{ secrets.ANDROID_KEY_ALIAS }}"
          KEY_ALIAS="${KEY_ALIAS:-upload}"
          
          # 使用 sed 替换配置值
          sed -i "s|storePassword=.*|storePassword=${{ secrets.ANDROID_KEYSTORE_PASSWORD }}|" sign-apk/keystore.properties
          sed -i "s|keyPassword=.*|keyPassword=${{ secrets.ANDROID_KEY_PASSWORD }}|" sign-apk/keystore.properties
          sed -i "s|keyAlias=.*|keyAlias=$KEY_ALIAS|" sign-apk/keystore.properties
          sed -i "s|storeFile=.*|storeFile=$KEYSTORE_PATH|" sign-apk/keystore.properties
          
          echo "✅ 已创建并配置 sign-apk/keystore.properties"
          echo "密钥库位置: $KEYSTORE_PATH"
          
          # 运行签名配置脚本
          chmod +x sign-apk/setup-android-signing.sh
          ./sign-apk/setup-android-signing.sh

      - name: Build Android APK
        run: |
          pnpm run build:mobile --apk true
        env:
          ANDROID_HOME: ${{ env.ANDROID_HOME }}
          ANDROID_NDK_HOME: ${{ env.ANDROID_NDK_HOME }}

      - name: Upload APK
        uses: actions/upload-artifact@v4
        with:
          name: Stationuli-android.apk
          path: apps/mobile/src-tauri/gen/android/app/build/outputs/apk/universal/release/*.apk
          retention-days: 7

  create-release:
    if: ${{ always() && inputs.create_release == true }}
    needs: [build-mac, build-windows, build-android]
    permissions:
      contents: write
    runs-on: ubuntu-latest
    steps:
      - name: Checkout code
        uses: actions/checkout@v4

      - name: Download all artifacts
        uses: actions/download-artifact@v4
        continue-on-error: true
        with:
          path: artifacts

      - name: Get version from package.json
        id: get_version
        run: |
          VERSION=$(node -p "require('./package.json').version")
          echo "version=$VERSION" >> $GITHUB_OUTPUT
          echo "版本: $VERSION"

      - name: List available artifacts
        run: |
          echo "=== 可用的构建产物 ==="
          find artifacts -type f 2>/dev/null | head -20 || echo "未找到构建产物"

      - name: Generate release body
        id: release_body
        run: |
          BODY="## 发布版本 v${{ steps.get_version.outputs.version }}
          
          ### 构建产物
          
          本次发布包含以下平台的构建产物：
          "
          
          if [ "${{ inputs.target }}" == "mac" ] || [ "${{ inputs.target }}" == "all" ]; then
            BODY="$BODY
          - macOS (ARM64 和 x86_64)"
          fi
          
          if [ "${{ inputs.target }}" == "windows" ] || [ "${{ inputs.target }}" == "all" ]; then
            BODY="$BODY
          - Windows (MSI 和 NSIS)"
          fi
          
          if [ "${{ inputs.target }}" == "android" ] || [ "${{ inputs.target }}" == "all" ]; then
            BODY="$BODY
          - Android (APK)"
          fi
          
          BODY="$BODY
          
          ### 下载
          
          请从下方的 Assets 中下载对应平台的安装包。"
          
          echo "body<<EOF" >> $GITHUB_OUTPUT
          echo "$BODY" >> $GITHUB_OUTPUT
          echo "EOF" >> $GITHUB_OUTPUT

      - name: Create Release
        uses: softprops/action-gh-release@v1
        with:
          tag_name: v${{ steps.get_version.outputs.version }}
          name: Release v${{ steps.get_version.outputs.version }}
          body: ${{ steps.release_body.outputs.body }}
          files: |
            artifacts/**/*
          draft: false
          prerelease: false
        env:
          GITHUB_TOKEN: ${{ secrets.GITHUB_TOKEN }}
